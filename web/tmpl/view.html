<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Flow Viewer</title>
    <meta name="description" content="TODO">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="/static/js/go-debug.js"></script>
    <script>
    function init() {
      var $ = go.GraphObject.make;    // for conciseness in defining templates

      flowDiagram = $(go.Diagram, "flowDiv",
      {
        initialContentAlignment: go.Spot.Center, // center the content
        "grid.visible": true,
        "undoManager.isEnabled": true // enable Ctrl-Z to undo and Ctrl-Y to redo
      });

      // when the document is modified, add a "*" to the title and enable the "Save" button
      flowDiagram.addDiagramListener("Modified", function(e) {
        var button = document.getElementById("SaveButton");
        if (button) button.disabled = !flowDiagram.isModified;
        var idx = document.title.indexOf("*")
        if (flowDiagram.isModified) {
          if (idx < 0) document.title += "*";
        }
        else if (idx >= 0) {
          document.title = document.title.substr(0, idx);
        }
      });

      function nodeStyle() {
        return [
        new go.Binding("location", "loc", go.Point.parse).makeTwoWay(go.Point.stringify),
        {
          isShadowed: true
        }
        ];
      }

    flowDiagram.nodeTemplateMap.add("", // the default category
      $(go.Node, "Auto", nodeStyle(),   // the shape will go around the TextBlock
        $(go.Shape,
          new go.Binding("figure", "fig"), // Shape.figure is bound to Node.data.fig
          new go.Binding("fill", "color"), // Shape.fill is bound to Node.data.color
          new go.Binding("angle"),         // Shape.(angle|scale) is bound to Node.data.$1
          new go.Binding("scale")),
        $(go.TextBlock,
          { margin: 5 }, // leave some room around the text
          // TextBlock.text is bound to Node.data.key
          new go.Binding("text", "nodename").makeTwoWay())
        ));

    // using default Link template for now by not setting Diagram.linkTemplate

    // create the model data that will be represented by Nodes and Links
    //flowDiagram.model = new go.GraphLinksModel({{index .Workflow.Diagram "nodeDataArray"}},{{index .Workflow.Diagram "linkDataArray"}});
    flowDiagram.model = go.Model.fromJson({{.Workflow.Diagram}});
    document.getElementById("mySavedFlow").value = flowDiagram.model.toJson();
    }

    function save() {
      document.getElementById("mySavedFlow").value = flowDiagram.model.toJson();
      flowDiagram.isModified = false;
    }

    </script>
  </head>
  <body onload="init()">
    <h1>Flow Viewer</h1>
    <p>Hello world! This is workflow #{{printf "%d" .Workflow.UID}} owned by user {{printf "%s" .User.Username}}!</p>
    <div id="flowDiv" style="width:1000px; height:550px; background-color: #DAE4E4;"></div>
    <button id="SaveButton" onclick="save()">Write</button>
    <textarea id="mySavedFlow" style="width:100%;height:250px">
    testing
    </textarea>
  </body>
</html>
